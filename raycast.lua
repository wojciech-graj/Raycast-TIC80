-- title:  Raycast Engine Demo
-- author: Wojciech Graj
-- desc:   Demo of a WolfenStein3D-style raycast engine with variable-height walls.
-- script: lua
-- input: gamepad

Player = {
	pos_x = 0,
	pos_y = 0,
	dir_x = -1,
	dir_y = 0,
	plane_x = 0,
	plane_y = 0.8,
}
Player.__index = Player

function Player.new(pos_x, pos_y)
	local self = setmetatable({}, Player)
	self.pos_x = pos_x
	self.pos_y = pos_y
	return self
end

function Player:process(delta)
	if btn(2) then
		self:rotate(delta)
	elseif btn(3) then
		self:rotate(-delta)
	end
	if btn(0) then
		self:move(delta)
	elseif btn(1) then
		self:move(-delta)
	end
end

function Player:rotate(delta)
	local speed = 0.001 * delta --[CONST]
	local old_dir_x = self.dir_x
	local math_cos = math.cos
	local math_sin = math.sin
	self.dir_x = self.dir_x * math_cos(speed) - self.dir_y * math_sin(speed)
	self.dir_y = old_dir_x * math_sin(speed) + self.dir_y * math_cos(speed)
	local old_plane_x = self.plane_x
	self.plane_x = self.plane_x * math_cos(speed) - self.plane_y * math_sin(speed)
	self.plane_y = old_plane_x * math_sin(speed) + self.plane_y * math_cos(speed)
end

function Player:move(delta)
	local speed = 0.003 * delta --[CONST]
	local math_floor = math.floor
	if mget(math_floor(self.pos_x + self.dir_x * speed), math_floor(self.pos_y)) == 0 then
		self.pos_x = self.pos_x + self.dir_x * speed
	end
	if mget(math_floor(self.pos_x), math_floor(self.pos_y + self.dir_y * speed)) == 0 then
		self.pos_y = self.pos_y + self.dir_y * speed
	end
end

Sprite = {
	pos_x = 0,
	pos_y = 0,
	tex_id = 0,
	scl_horiz = 1,
	scl_vert = 1,
	offset_vert = 0, --from 0.5 (floor) to -0.5 (ceiling)
	screen_offset_vert = 0,
	dist = 0, --Distance to player (negative if not in viewing triangle)
	screen_x = 0,
	screen_width = 0,
	screen_height = 0,
	draw_start_y = 0,
	draw_end_y = 0,
	draw_start_x = 0,
	draw_end_x = 0,
}
Sprite.__index = Sprite

function Sprite.new(pos_x, pos_y, tex_id, scl_horiz, scl_vert, offset_vert)
	local self = setmetatable({}, Sprite)
	self.pos_x = pos_x
	self.pos_y = pos_y
	self.tex_id = tex_id
	self.scl_horiz = scl_horiz
	self.scl_vert = scl_vert
	self.offset_vert = offset_vert
	return self
end

function Sprite:process(inv_det)
	local screen_width = g_SCREEN_WIDTH
	local screen_height = g_SCREEN_HEIGHT
	local screen_half_height = screen_height / 2
	local player = g_player
	local math_abs = math.abs

	local rel_x = self.pos_x - player.pos_x
	local rel_y = self.pos_y - player.pos_y
	self.dist = math.sqrt(rel_x * rel_x + rel_y * rel_y)
	local trans_y = inv_det * (player.plane_x * rel_y - player.plane_y * rel_x)
	if trans_y <= 0 then
		self.dist = -self.dist
		return
	end
	local trans_x = inv_det * (player.dir_y * rel_x - player.dir_x * rel_y)
	self.screen_x = math.floor((screen_width * 0.5) * (1 + trans_x / trans_y))
	self.screen_width = math_abs(screen_height // trans_y) // self.scl_horiz
	self.draw_start_x = self.screen_x - self.screen_width // 2
	if self.draw_start_x < 0 then
		self.draw_start_x = 0
	elseif self.draw_start_x >= screen_width then
		self.dist = -self.dist
		return
	end
	self.draw_end_x = self.screen_x + self.screen_width // 2
	if self.draw_end_x >= screen_width then
		self.draw_end_x = screen_width - 1
	elseif self.draw_end_x < 0 then
		self.dist = -self.dist
		return
	end
	self.screen_height = math_abs(screen_height // trans_y) // self.scl_vert
	self.screen_offset_vert = screen_half_height * self.offset_vert // trans_y
	self.draw_start_y = screen_half_height - self.screen_height // 2 + self.screen_offset_vert
	if self.draw_start_y < 0 then
		self.draw_start_y = 0
	end
	self.draw_end_y = screen_half_height + self.screen_height // 2 + self.screen_offset_vert
	if self.draw_end_y >= screen_height then
		self.draw_end_y = screen_height - 1
	end
end

function get_tex_pixel(offset, id, x, y)
	return peek4(offset + 0x40 * (id + 16 * (y // 8) + x // 8) + 0x8 * (y % 8) + (x % 8))
end

function init()
	g_SCREEN_WIDTH = 240
	g_SCREEN_HEIGHT = 136
	g_DEBUG = true
	g_TEX_WIDTH = 16
	g_TEX_HEIGHT = 16
	g_SPRITE_SIZES = {
		[0]={16,16},
		[2]={16,16},
	}
	g_TEX_MAP = {
		[1]=1,
		[2]=3,
		[3]=5,
		[4]=7,
		[5]=9,
	}
	g_player = Player.new(22, 12)
	g_prev_time = 0
	g_sprites = {
		Sprite.new(12, 13, 0, 2, 2, 0.5),
		Sprite.new(12.5, 12.5, 0, 2, 2, 0.5),
		Sprite.new(13, 13, 0, 2, 2, 0.5),
		Sprite.new(18.5, 6.5, 2, 2, 1, 0.125),
	}
	g_settings = {
		floor_ceil = true,
		interlace = 2, --disabled=g_interlace>=2
	}
end

init()
function TIC()
	local t = time()
	local delta = t - g_prev_time --msec since last frame
	g_prev_time = t

	local screen_width = g_SCREEN_WIDTH
	local screen_height = g_SCREEN_HEIGHT
	local screen_half_height = screen_height // 2
	local tex_width = g_TEX_WIDTH
	local tex_height = g_TEX_HEIGHT
	local sprite_sizes = g_SPRITE_SIZES
	local tex_map = g_TEX_MAP
	local player = g_player
	local sprites = g_sprites
	local settings = g_settings
	local math_floor = math.floor
	local math_abs = math.abs

	local start_vline
	local step_vline
	if settings.interlace >= 2 then
		start_vline = 0
		step_vline = 1
		cls(0)
	else
		start_vline = (settings.interlace + 1) % 2
		settings.interlace = start_vline
		step_vline = 2
		for x=start_vline,screen_width-1,step_vline do
			for y=0,screen_height-1 do
				pix(x, y, 0)
			end
		end
	end

	-- game logic
	t = time()

	player:process(delta)

	if btnp(4) then
		if settings.interlace >= 2 then
			settings.interlace = 0
		else
			settings.interlace = 2
		end
	end
	if btnp(5) then
		settings.floor_ceil = not settings.floor_ceil
	end

	local t_temp = time()
	local t_logic = t_temp - t
	t = t_temp

	-- drawing

	local inv_det = 1 / (player.plane_x * player.dir_y - player.dir_x * player.plane_y)
	local visible_sprites = {}
	for key,sprite in pairs(sprites) do
		sprite:process(inv_det)
		if sprite.dist > 0 then
			visible_sprites[#visible_sprites+1] = sprite
		end
	end

	table.sort(visible_sprites, function(a,b) return a.dist < b.dist end)
	local num_visible_sprites = #visible_sprites

	-- draw walls and sprites
	for x=start_vline,screen_width-1,step_vline do
		local camera_x = 2 * x / screen_width - 1
		local ray_dir_x = player.dir_x + player.plane_x * camera_x
		local ray_dir_y = player.dir_y + player.plane_y * camera_x
		local map_x = math_floor(player.pos_x)
		local map_y = math_floor(player.pos_y)
		local delta_dist_x = math_abs(1 / ray_dir_x)
		local delta_dist_y = math_abs(1 / ray_dir_y)

		local step_x
		local side_dist_x
		if ray_dir_x < 0 then
			step_x = -1
			side_dist_x = (player.pos_x - map_x) * delta_dist_x
		else
			step_x = 1
			side_dist_x = (map_x + 1.0 - player.pos_x) * delta_dist_x
		end

		local step_y
		local side_dist_y
		if ray_dir_y < 0 then
			step_y = -1
			side_dist_y = (player.pos_y - map_y) * delta_dist_y
		else
			step_y = 1
			side_dist_y = (map_y + 1.0 - player.pos_y) * delta_dist_y
		end

		local current_sprite = 1
		local not_hit_full_wall = true
		local prev_draw_start = screen_height
		while not_hit_full_wall do
			-- Get next wall tile using DDA
			local side
			local tile_data
			local not_hit = true
			while not_hit do
				if side_dist_x < side_dist_y then
					side_dist_x = side_dist_x + delta_dist_x
					map_x = map_x + step_x
					side = 0
				else
					side_dist_y = side_dist_y + delta_dist_y
					map_y = map_y + step_y
					side = 1
				end
				tile_data = mget(map_x, map_y)
				if tile_data > 0 then
					not_hit = false
				end
			end

			local perp_wall_dist
			if side == 0 then
				perp_wall_dist = (map_x - player.pos_x + (1 - step_x) * 0.5) / ray_dir_x
			else
				perp_wall_dist = (map_y - player.pos_y + (1 - step_y) * 0.5) / ray_dir_y
			end

			--draw sprites
			for sprite_idx=current_sprite,num_visible_sprites do
				local sprite = visible_sprites[sprite_idx]
				if sprite.dist >= perp_wall_dist then
					break
				end
				current_sprite = sprite_idx + 1
				if x >= sprite.draw_start_x and x <= sprite.draw_end_x then
					local sprite_size = sprite_sizes[sprite.tex_id]
					local a = sprite_size[2] / sprite.screen_height
					local sprite_tex_x = math_floor((x - (sprite.screen_x - sprite.screen_width / 2)) * sprite_size[1] / sprite.screen_width) % sprite_size[1]
					for y=sprite.draw_start_y,sprite.draw_end_y do
						local tex_y = math_floor((y - sprite.screen_offset_vert - screen_half_height + sprite.screen_height / 2) * a) % sprite_size[2]
						local color = get_tex_pixel(0xC000, sprite.tex_id, sprite_tex_x, tex_y)
						if color > 0 and pix(x, y) == 0 then
							pix(x, y, color)
						end
					end
				end
			end

			--draw wall
			local tile_height = tile_data // 16 / 16 -- 0=full height, 1=no height
			if tile_height == 0 then
				not_hit_full_wall = false
			end

			local line_height = screen_height // perp_wall_dist
			local draw_start = screen_half_height + math_floor(line_height * (tile_height - 0.5)) + 1
			if draw_start < 0 then
				draw_start = 0
			elseif draw_start >= screen_height then
				draw_start = screen_height - 1
			end
			local draw_end = screen_half_height + line_height // 2 - 1
			if draw_end > prev_draw_start then
				draw_end = prev_draw_start
			elseif draw_end >= screen_height then
				draw_end = screen_height - 1
			end

			local wall_x
			if side == 0 then
				wall_x = player.pos_y + perp_wall_dist * ray_dir_y
			else
				wall_x = player.pos_x + perp_wall_dist * ray_dir_x
			end
			wall_x = wall_x - math_floor(wall_x)

			local tex_id = tex_map[tile_data % 16]
			local tex_x = math_floor(wall_x * tex_width)

			local step_tex = tex_height / line_height
			local testart_vline = (draw_start - screen_half_height + line_height * 0.5) * step_tex

			for y=draw_start,draw_end do
				if pix(x, y) == 0 then
					local tex_y = math_floor(testart_vline + step_tex * (y - draw_start)) % tex_height
					pix(x, y, get_tex_pixel(0x8000, tex_id, tex_x, tex_y))
				end
			end

			--draw top of variable-height walls
			if tile_height > 0.5 then
				if side_dist_x < side_dist_y then
					perp_wall_dist = (map_x + step_x - player.pos_x + (1 - step_x) * 0.5) / ray_dir_x
				else
					perp_wall_dist = (map_y + step_y - player.pos_y + (1 - step_y) * 0.5) / ray_dir_y
				end
				line_height = screen_height // perp_wall_dist
				local top_draw_start = screen_half_height + math_floor(line_height * (tile_height - 0.5))
				if top_draw_start >= screen_height then
					top_draw_start = screen_height - 1
				end
				local row_distance_part = (2 * tile_height - 1) * screen_half_height
				for y=top_draw_start,draw_start - 1 do
					if pix(x, y) == 0 then
						local row_distance = row_distance_part / (y - screen_half_height)
						local floor_x = player.pos_x + row_distance * ray_dir_x
						local floor_y = player.pos_y + row_distance * ray_dir_y
						local tex_x = math_floor(tex_width * floor_x) % tex_width
						local tex_y = math_floor(tex_height * floor_y) % tex_height
						pix(x, y, get_tex_pixel(0x8000, tex_id, tex_x, tex_y))
					end
				end
				prev_draw_start = top_draw_start
			else
				prev_draw_start = draw_start
			end
		end
	end

	t_temp = time()
	local t_wall_sprite = t_temp - t
	t = t_temp

	--draw floor + ceiling
	if settings.floor_ceil then
		local ray_dir_x0 = player.dir_x - player.plane_x
		local ray_dir_y0 = player.dir_y - player.plane_y
		local ray_dir_x1 = player.dir_x + player.plane_x
		local ray_dir_y1 = player.dir_y + player.plane_y
		for y=screen_half_height,screen_height do
			local row_distance = screen_half_height / (y - screen_half_height)
			local floor_step_x = row_distance * (ray_dir_x1 - ray_dir_x0) / screen_width
			local floor_step_y = row_distance * (ray_dir_y1 - ray_dir_y0) / screen_width
			local floor_x = player.pos_x + row_distance * ray_dir_x0 + start_vline * floor_step_x
			local floor_y = player.pos_y + row_distance * ray_dir_y0 + start_vline * floor_step_y
			floor_step_x = floor_step_x * step_vline
			floor_step_y = floor_step_y * step_vline
			for x=start_vline,screen_width-1,step_vline do
				local tex_x = math_floor(tex_width * floor_x) % tex_width
				local tex_y = math_floor(tex_height * floor_y) % tex_height

				-- draw floor
				if pix(x, y) == 0 then
					pix(x, y, get_tex_pixel(0x8000, 3, tex_x, tex_y)) --[CONST]
				end

				--draw ceiling
				if pix(x, screen_height - y - 1) == 0 then
					pix(x, screen_height - y - 1, get_tex_pixel(0x8000, 5, tex_x, tex_y)) --[CONST]
				end

				floor_x = floor_x + floor_step_x
				floor_y = floor_y + floor_step_y
			end
		end
	end

	t_temp = time()
	local t_floor = t_temp - t

	if g_DEBUG then
		print(string.format("FPS %d\n#SPR %d\nLOGIC %.1f\nWALL&SPR %.1f\nFLR&CEIL %.1f",
			math_floor(1000 / delta), num_visible_sprites, t_logic, t_wall_sprite, t_floor), 0, 0, 5)
	end
end

-- <TILES>
-- 001:ffffffffccedfccceeeefceeefeffeeffffffffffccddeeefceeeeeefeeeefef
-- 002:ffffffffdcdefcdceeeefceeefeffeeefffffffffcccdcedfceeeeeefeeeefef
-- 003:aaaaaaaaa8989989a99aaaa9a8aa8aaaa9a898aaa9aa8aaaa8aaaaaaa99aaaaa
-- 004:aaaaaaaa9899898a9aaaa99aaaa8aa8aaa898a9aaaa8aa9aaaaaaa8aaaaaa99a
-- 005:fffffeeefffeefffffeffffffefffffffeffffffefffffffefffffffefffffff
-- 006:eeeffffffffeeffffffffeffffffffefffffffeffffffffefffffffefffffffe
-- 007:3444444433444444333444443333444433333444333333443333333433333333
-- 008:4444444344444433444443334444333344433333443333334333333333333333
-- 009:7777777777666677766666677666666776666667766666677766667777777777
-- 010:7777777777666677766666677666666776666667766666677766667777777777
-- 016:0000000000000000000000000001100000011000000000000000000000000000
-- 017:ffffffffccedfccceeeefceeefeffeeffffffffffccddeeefceeeeeefeeeefef
-- 018:ffffffffdcdefcdceeeefceeefeffeeefffffffffcccdcedfceeeeeefeeeefef
-- 019:a99aaaaaa8aaaaaaa9aa8aaaa9a898aaa8aa8aaaa99aaaa9a8989989aaaaaaaa
-- 020:aaaaa99aaaaaaa8aaaa8aa9aaa898a9aaaa8aa8a9aaaa99a9899898aaaaaaaaa
-- 021:efffffffefffffffeffffffffefffffffeffffffffeffffffffeeffffffffeee
-- 022:fffffffefffffffefffffffeffffffefffffffeffffffefffffeefffeeefffff
-- 023:3333333333333334333333443333344433334444333444443344444434444444
-- 024:3333333343333333443333334443333344443333444443334444443344444443
-- 025:7777777777666677766666677666666776666667766666677766667777777777
-- 026:7777777777666677766666677666666776666667766666677766667777777777
-- 027:0000000000000000000000000001100000011000000000000000000000000000
-- 028:0000000000000000000000000001100000011000000000000000000000000000
-- 029:0000000000000000000000000001100000011000000000000000000000000000
-- 030:0000000000000000000000000001100000011000000000000000000000000000
-- 031:0000000000000000000000000001100000011000000000000000000000000000
-- 032:0000000000000000000000000002200000022000000000000000000000000000
-- 033:0000000000000000000000000002200000022000000000000000000000000000
-- 034:0000000000000000000000000002200000022000000000000000000000000000
-- 035:0000000000000000000000000002200000022000000000000000000000000000
-- 036:0000000000000000000000000002200000022000000000000000000000000000
-- 037:0000000000000000000000000002200000022000000000000000000000000000
-- 038:0000000000000000000000000002200000022000000000000000000000000000
-- 039:0000000000000000000000000002200000022000000000000000000000000000
-- 040:0000000000000000000000000002200000022000000000000000000000000000
-- 041:0000000000000000000000000002200000022000000000000000000000000000
-- 042:0000000000000000000000000002200000022000000000000000000000000000
-- 043:0000000000000000000000000002200000022000000000000000000000000000
-- 044:0000000000000000000000000002200000022000000000000000000000000000
-- 045:0000000000000000000000000002200000022000000000000000000000000000
-- 046:0000000000000000000000000002200000022000000000000000000000000000
-- 047:0000000000000000000000000002200000022000000000000000000000000000
-- 048:0000000000000000000000000003300000033000000000000000000000000000
-- 049:0000000000000000000000000003300000033000000000000000000000000000
-- 050:0000000000000000000000000003300000033000000000000000000000000000
-- 051:0000000000000000000000000003300000033000000000000000000000000000
-- 052:0000000000000000000000000003300000033000000000000000000000000000
-- 053:0000000000000000000000000003300000033000000000000000000000000000
-- 054:0000000000000000000000000003300000033000000000000000000000000000
-- 055:0000000000000000000000000003300000033000000000000000000000000000
-- 056:0000000000000000000000000003300000033000000000000000000000000000
-- 057:0000000000000000000000000003300000033000000000000000000000000000
-- 058:0000000000000000000000000003300000033000000000000000000000000000
-- 059:0000000000000000000000000003300000033000000000000000000000000000
-- 060:0000000000000000000000000003300000033000000000000000000000000000
-- 061:0000000000000000000000000003300000033000000000000000000000000000
-- 062:0000000000000000000000000003300000033000000000000000000000000000
-- 063:0000000000000000000000000003300000033000000000000000000000000000
-- 064:0000000000000000000000000004400000044000000000000000000000000000
-- 065:0000000000000000000000000004400000044000000000000000000000000000
-- 066:0000000000000000000000000004400000044000000000000000000000000000
-- 067:0000000000000000000000000004400000044000000000000000000000000000
-- 068:0000000000000000000000000004400000044000000000000000000000000000
-- 069:0000000000000000000000000004400000044000000000000000000000000000
-- 070:0000000000000000000000000004400000044000000000000000000000000000
-- 071:0000000000000000000000000004400000044000000000000000000000000000
-- 072:0000000000000000000000000004400000044000000000000000000000000000
-- 073:0000000000000000000000000004400000044000000000000000000000000000
-- 074:0000000000000000000000000004400000044000000000000000000000000000
-- 075:0000000000000000000000000004400000044000000000000000000000000000
-- 076:0000000000000000000000000004400000044000000000000000000000000000
-- 077:0000000000000000000000000004400000044000000000000000000000000000
-- 078:0000000000000000000000000004400000044000000000000000000000000000
-- 079:0000000000000000000000000004400000044000000000000000000000000000
-- 080:0000000000000000000000000005500000055000000000000000000000000000
-- 081:0000000000000000000000000005500000055000000000000000000000000000
-- 082:0000000000000000000000000005500000055000000000000000000000000000
-- 083:0000000000000000000000000005500000055000000000000000000000000000
-- 084:0000000000000000000000000005500000055000000000000000000000000000
-- 085:0000000000000000000000000005500000055000000000000000000000000000
-- 086:0000000000000000000000000005500000055000000000000000000000000000
-- 087:0000000000000000000000000005500000055000000000000000000000000000
-- 088:0000000000000000000000000005500000055000000000000000000000000000
-- 089:0000000000000000000000000005500000055000000000000000000000000000
-- 090:0000000000000000000000000005500000055000000000000000000000000000
-- 091:0000000000000000000000000005500000055000000000000000000000000000
-- 092:0000000000000000000000000005500000055000000000000000000000000000
-- 093:0000000000000000000000000005500000055000000000000000000000000000
-- 094:0000000000000000000000000005500000055000000000000000000000000000
-- 095:0000000000000000000000000005500000055000000000000000000000000000
-- 096:0000000000000000000000000006600000066000000000000000000000000000
-- 097:0000000000000000000000000006600000066000000000000000000000000000
-- 098:0000000000000000000000000006600000066000000000000000000000000000
-- 099:0000000000000000000000000006600000066000000000000000000000000000
-- 100:0000000000000000000000000006600000066000000000000000000000000000
-- 101:0000000000000000000000000006600000066000000000000000000000000000
-- 102:0000000000000000000000000006600000066000000000000000000000000000
-- 103:0000000000000000000000000006600000066000000000000000000000000000
-- 104:0000000000000000000000000006600000066000000000000000000000000000
-- 105:0000000000000000000000000006600000066000000000000000000000000000
-- 106:0000000000000000000000000006600000066000000000000000000000000000
-- 107:0000000000000000000000000006600000066000000000000000000000000000
-- 108:0000000000000000000000000006600000066000000000000000000000000000
-- 109:0000000000000000000000000006600000066000000000000000000000000000
-- 110:0000000000000000000000000006600000066000000000000000000000000000
-- 111:0000000000000000000000000006600000066000000000000000000000000000
-- 112:0000000000000000000000000007700000077000000000000000000000000000
-- 113:0000000000000000000000000007700000077000000000000000000000000000
-- 114:0000000000000000000000000007700000077000000000000000000000000000
-- 115:0000000000000000000000000007700000077000000000000000000000000000
-- 116:0000000000000000000000000007700000077000000000000000000000000000
-- 117:0000000000000000000000000007700000077000000000000000000000000000
-- 118:0000000000000000000000000007700000077000000000000000000000000000
-- 119:0000000000000000000000000007700000077000000000000000000000000000
-- 120:0000000000000000000000000007700000077000000000000000000000000000
-- 121:0000000000000000000000000007700000077000000000000000000000000000
-- 122:0000000000000000000000000007700000077000000000000000000000000000
-- 123:0000000000000000000000000007700000077000000000000000000000000000
-- 124:0000000000000000000000000007700000077000000000000000000000000000
-- 125:0000000000000000000000000007700000077000000000000000000000000000
-- 126:0000000000000000000000000007700000077000000000000000000000000000
-- 127:0000000000000000000000000007700000077000000000000000000000000000
-- 128:0000000000000000000000000008800000088000000000000000000000000000
-- 129:0000000000000000000000000008800000088000000000000000000000000000
-- 130:0000000000000000000000000008800000088000000000000000000000000000
-- 131:0000000000000000000000000008800000088000000000000000000000000000
-- 132:0000000000000000000000000008800000088000000000000000000000000000
-- 133:0000000000000000000000000008800000088000000000000000000000000000
-- 134:0000000000000000000000000008800000088000000000000000000000000000
-- 135:0000000000000000000000000008800000088000000000000000000000000000
-- 136:0000000000000000000000000008800000088000000000000000000000000000
-- 137:0000000000000000000000000008800000088000000000000000000000000000
-- 138:0000000000000000000000000008800000088000000000000000000000000000
-- 139:0000000000000000000000000008800000088000000000000000000000000000
-- 140:0000000000000000000000000008800000088000000000000000000000000000
-- 141:0000000000000000000000000008800000088000000000000000000000000000
-- 142:0000000000000000000000000008800000088000000000000000000000000000
-- 143:0000000000000000000000000008800000088000000000000000000000000000
-- 144:0000000000000000000000000009900000099000000000000000000000000000
-- 145:0000000000000000000000000009900000099000000000000000000000000000
-- 146:0000000000000000000000000009900000099000000000000000000000000000
-- 147:0000000000000000000000000009900000099000000000000000000000000000
-- 148:0000000000000000000000000009900000099000000000000000000000000000
-- 149:0000000000000000000000000009900000099000000000000000000000000000
-- 150:0000000000000000000000000009900000099000000000000000000000000000
-- 151:0000000000000000000000000009900000099000000000000000000000000000
-- 152:0000000000000000000000000009900000099000000000000000000000000000
-- 153:0000000000000000000000000009900000099000000000000000000000000000
-- 154:0000000000000000000000000009900000099000000000000000000000000000
-- 155:0000000000000000000000000009900000099000000000000000000000000000
-- 156:0000000000000000000000000009900000099000000000000000000000000000
-- 157:0000000000000000000000000009900000099000000000000000000000000000
-- 158:0000000000000000000000000009900000099000000000000000000000000000
-- 159:0000000000000000000000000009900000099000000000000000000000000000
-- 160:000000000000000000000000000aa000000aa000000000000000000000000000
-- 161:000000000000000000000000000aa000000aa000000000000000000000000000
-- 162:000000000000000000000000000aa000000aa000000000000000000000000000
-- 163:000000000000000000000000000aa000000aa000000000000000000000000000
-- 164:000000000000000000000000000aa000000aa000000000000000000000000000
-- 165:000000000000000000000000000aa000000aa000000000000000000000000000
-- 166:000000000000000000000000000aa000000aa000000000000000000000000000
-- 167:000000000000000000000000000aa000000aa000000000000000000000000000
-- 168:000000000000000000000000000aa000000aa000000000000000000000000000
-- 169:000000000000000000000000000aa000000aa000000000000000000000000000
-- 170:000000000000000000000000000aa000000aa000000000000000000000000000
-- 171:000000000000000000000000000aa000000aa000000000000000000000000000
-- 172:000000000000000000000000000aa000000aa000000000000000000000000000
-- 173:000000000000000000000000000aa000000aa000000000000000000000000000
-- 174:000000000000000000000000000aa000000aa000000000000000000000000000
-- 175:000000000000000000000000000aa000000aa000000000000000000000000000
-- 176:000000000000000000000000000bb000000bb000000000000000000000000000
-- 177:000000000000000000000000000bb000000bb000000000000000000000000000
-- 178:000000000000000000000000000bb000000bb000000000000000000000000000
-- 179:000000000000000000000000000bb000000bb000000000000000000000000000
-- 180:000000000000000000000000000bb000000bb000000000000000000000000000
-- 181:000000000000000000000000000bb000000bb000000000000000000000000000
-- 182:000000000000000000000000000bb000000bb000000000000000000000000000
-- 183:000000000000000000000000000bb000000bb000000000000000000000000000
-- 184:000000000000000000000000000bb000000bb000000000000000000000000000
-- 185:000000000000000000000000000bb000000bb000000000000000000000000000
-- 186:000000000000000000000000000bb000000bb000000000000000000000000000
-- 187:000000000000000000000000000bb000000bb000000000000000000000000000
-- 188:000000000000000000000000000bb000000bb000000000000000000000000000
-- 189:000000000000000000000000000bb000000bb000000000000000000000000000
-- 190:000000000000000000000000000bb000000bb000000000000000000000000000
-- 191:000000000000000000000000000bb000000bb000000000000000000000000000
-- 192:000000000000000000000000000cc000000cc000000000000000000000000000
-- 193:000000000000000000000000000cc000000cc000000000000000000000000000
-- 194:000000000000000000000000000cc000000cc000000000000000000000000000
-- 195:000000000000000000000000000cc000000cc000000000000000000000000000
-- 196:000000000000000000000000000cc000000cc000000000000000000000000000
-- 197:000000000000000000000000000cc000000cc000000000000000000000000000
-- 198:000000000000000000000000000cc000000cc000000000000000000000000000
-- 199:000000000000000000000000000cc000000cc000000000000000000000000000
-- 200:000000000000000000000000000cc000000cc000000000000000000000000000
-- 201:000000000000000000000000000cc000000cc000000000000000000000000000
-- 202:000000000000000000000000000cc000000cc000000000000000000000000000
-- 203:000000000000000000000000000cc000000cc000000000000000000000000000
-- 204:000000000000000000000000000cc000000cc000000000000000000000000000
-- 205:000000000000000000000000000cc000000cc000000000000000000000000000
-- 206:000000000000000000000000000cc000000cc000000000000000000000000000
-- 207:000000000000000000000000000cc000000cc000000000000000000000000000
-- 208:000000000000000000000000000dd000000dd000000000000000000000000000
-- 209:000000000000000000000000000dd000000dd000000000000000000000000000
-- 210:000000000000000000000000000dd000000dd000000000000000000000000000
-- 211:000000000000000000000000000dd000000dd000000000000000000000000000
-- 212:000000000000000000000000000dd000000dd000000000000000000000000000
-- 213:000000000000000000000000000dd000000dd000000000000000000000000000
-- 214:000000000000000000000000000dd000000dd000000000000000000000000000
-- 215:000000000000000000000000000dd000000dd000000000000000000000000000
-- 216:000000000000000000000000000dd000000dd000000000000000000000000000
-- 217:000000000000000000000000000dd000000dd000000000000000000000000000
-- 218:000000000000000000000000000dd000000dd000000000000000000000000000
-- 219:000000000000000000000000000dd000000dd000000000000000000000000000
-- 220:000000000000000000000000000dd000000dd000000000000000000000000000
-- 221:000000000000000000000000000dd000000dd000000000000000000000000000
-- 222:000000000000000000000000000dd000000dd000000000000000000000000000
-- 223:000000000000000000000000000dd000000dd000000000000000000000000000
-- 224:000000000000000000000000000ee000000ee000000000000000000000000000
-- 225:000000000000000000000000000ee000000ee000000000000000000000000000
-- 226:000000000000000000000000000ee000000ee000000000000000000000000000
-- 227:000000000000000000000000000ee000000ee000000000000000000000000000
-- 228:000000000000000000000000000ee000000ee000000000000000000000000000
-- 229:000000000000000000000000000ee000000ee000000000000000000000000000
-- 230:000000000000000000000000000ee000000ee000000000000000000000000000
-- 231:000000000000000000000000000ee000000ee000000000000000000000000000
-- 232:000000000000000000000000000ee000000ee000000000000000000000000000
-- 233:000000000000000000000000000ee000000ee000000000000000000000000000
-- 234:000000000000000000000000000ee000000ee000000000000000000000000000
-- 235:000000000000000000000000000ee000000ee000000000000000000000000000
-- 236:000000000000000000000000000ee000000ee000000000000000000000000000
-- 237:000000000000000000000000000ee000000ee000000000000000000000000000
-- 238:000000000000000000000000000ee000000ee000000000000000000000000000
-- 239:000000000000000000000000000ee000000ee000000000000000000000000000
-- 240:000000000000000000000000000ff000000ff000000000000000000000000000
-- 241:000000000000000000000000000ff000000ff000000000000000000000000000
-- 242:000000000000000000000000000ff000000ff000000000000000000000000000
-- 243:000000000000000000000000000ff000000ff000000000000000000000000000
-- 244:000000000000000000000000000ff000000ff000000000000000000000000000
-- 245:000000000000000000000000000ff000000ff000000000000000000000000000
-- 246:000000000000000000000000000ff000000ff000000000000000000000000000
-- 247:000000000000000000000000000ff000000ff000000000000000000000000000
-- 248:000000000000000000000000000ff000000ff000000000000000000000000000
-- 249:000000000000000000000000000ff000000ff000000000000000000000000000
-- 250:000000000000000000000000000ff000000ff000000000000000000000000000
-- 251:000000000000000000000000000ff000000ff000000000000000000000000000
-- 252:000000000000000000000000000ff000000ff000000000000000000000000000
-- 253:000000000000000000000000000ff000000ff000000000000000000000000000
-- 254:000000000000000000000000000ff000000ff000000000000000000000000000
-- 255:000000000000000000000000000ff000000ff000000000000000000000000000
-- </TILES>

-- <SPRITES>
-- 000:0000eeee00ff22220f222c2202ff22220222eeee0f2222220ff2222202ffeeee
-- 001:eeee00002222dd00222222d02222dd20eeee2220222222d022222dd0eeeedd20
-- 002:0000000002200000020000020c00000c0c00000c0c00000c4440003404000003
-- 003:000000002200000220000022c00000c0c00000c0c00000c04400044440000040
-- 016:022feeee0f2222220ff2222202ffeeee022feeee0f22222200ff22220000eeee
-- 017:eeeed220222222d022222dd0eeeedd20eeeed220222222d02222dd00eeee0000
-- 018:0400000303440003000344430000000300000003000000030000033400003444
-- 019:4000004040004430444430004000000040000000400000004440000044440000
-- </SPRITES>

-- <MAP>
-- 000:101010101010101010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 001:100000000000000000000000000000001010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 002:100000000000000000000000000000001000000000001010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 003:100000000000000000000000000000001010001010001010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 004:100000000000000000000000000000001000000010001010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 005:1000005d1d5d1d5d1d5d0000000000001000000010001010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 006:1000001d5a1a5a1a5a1d0000000000001000000010001010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 007:1000005d1a5616561a5d0000000000001000000010001010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 008:1000001d5a1650165a1d00000000000010181c1810001010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 009:1000005d1a5616561a5d0000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 010:1000001d5a1a5a1a5a1d0000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 011:1000005d1d5d1d5d1d5d0000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 012:100000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 013:100000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 014:100000500050005000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 015:100000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 016:100000500050005000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 017:100000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 018:100000500050005000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 019:100000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 020:10000000000000004f4e4d4c4b4a49484746454443424110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 021:100000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 022:100000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 023:101010101010101010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </MAP>

-- <PALETTE>
-- 000:1a1c2c5d275db13e53ef7d57ffcd75a7f07038b76425717929366f3b5dc941a6f673eff7f4f4f494b0c2566c86333c57
-- </PALETTE>
